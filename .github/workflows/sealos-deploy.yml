name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
on:
  push:
    branches:
      - master # ç›‘å¬ master åˆ†æ”¯çš„ push äº‹ä»¶

env:
  DOCKER_IMAGE_NAME: nextjs-blog # ç»Ÿä¸€é•œåƒåç§°
  IMAGE_FILE_NAME: nextjs-blog.tar
  # æœåŠ¡å™¨ä¸Šçš„ç›®æ ‡ç›®å½•
  REMOTE_IMAGE_DIR: /home/blog
  # æ‚¨æä¾›çš„æ„å»ºå‚æ•°/ç¯å¢ƒå˜é‡
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
  OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
  OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
  OSS_REGION: ${{ secrets.OSS_REGION }}
  MONGODB_URI: ${{ secrets.MONGODB_URI }}

jobs:
  build:
    name: ğŸ—ï¸ ç”Ÿæˆ Docker é•œåƒæ–‡ä»¶
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”¥ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # å¯é€‰ï¼šè®¾ç½®ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º
      - name: ğŸ“‚ ç¼“å­˜ Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ğŸ§± æ„å»º Docker é•œåƒå¹¶å¯¼å‡ºä¸º tar æ–‡ä»¶
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          tags: ${{ env.DOCKER_IMAGE_NAME }}:amd # ä½¿ç”¨ç»Ÿä¸€çš„é•œåƒåç§°
          outputs: type=docker,dest=${{ env.IMAGE_FILE_NAME }} # å¯¼å‡ºä¸º tar æ–‡ä»¶
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          # ä¼ å…¥æ„å»ºå‚æ•°
          build-args: |
            JWT_SECRET=${{ env.JWT_SECRET }}
            ADMIN_PASSWORD=${{ env.ADMIN_PASSWORD }}
            ADMIN_USERNAME=${{ env.ADMIN_USERNAME }}
            OSS_BUCKET=${{ env.OSS_BUCKET }}
            OSS_ACCESS_KEY_SECRET=${{ env.OSS_ACCESS_KEY_SECRET }}
            OSS_ACCESS_KEY_ID=${{ env.OSS_ACCESS_KEY_ID }}
            OSS_REGION=${{ env.OSS_REGION }}
            MONGODB_URI=${{ env.MONGODB_URI }}

      # å¯é€‰ï¼šæ¸…ç†ç¼“å­˜
      - name: ğŸ”„ ç§»åŠ¨ç¼“å­˜
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ğŸ“¤ å¯¼å‡º Docker é•œåƒæ–‡ä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-artifact
          path: ${{ env.IMAGE_FILE_NAME }}
          retention-days: 1 # è®¾ç½®æ–‡ä»¶ä¿ç•™ä¸€å¤©

  deploy:
    name: â˜ï¸ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ å¯¼å…¥ Docker é•œåƒæ–‡ä»¶ (Download Artifact)
        uses: actions/download-artifact@v4
        with:
          name: docker-image-artifact
          path: images # ä¸‹è½½åˆ° images ç›®å½•

      - name: ğŸ“ è°ƒè¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        run: ls -l images

      - name: â« ä¸Šä¼  Docker é•œåƒæ–‡ä»¶åˆ°æœåŠ¡å™¨ /home/blog
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: images/${{ env.IMAGE_FILE_NAME }} # ä¸Šä¼ å…·ä½“çš„æ–‡ä»¶
          target: ${{ env.REMOTE_IMAGE_DIR }} # ç›®æ ‡ç›®å½•ä¸º /home/blog
          strip_components: 1

      - name: ğŸ”„ é‡å¯ Docker å®¹å™¨ (Restart Docker Container)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. å¯¼å…¥é•œåƒ (Import Docker Image)
            echo "å¯¼å…¥ Docker é•œåƒ: ${{ env.REMOTE_IMAGE_DIR }}/${{ env.IMAGE_FILE_NAME }}"
            docker load -i ${{ env.REMOTE_IMAGE_DIR }}/${{ env.IMAGE_FILE_NAME }}

            # 2. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨: ${{ env.DOCKER_IMAGE_NAME }}"
            docker stop ${{ env.DOCKER_IMAGE_NAME }} || true
            docker rm ${{ env.DOCKER_IMAGE_NAME }} || true

            # 3. è¿è¡Œæ–°å®¹å™¨
            echo "è¿è¡Œæ–°å®¹å™¨"
            # æ˜ å°„æ‚¨çš„åº”ç”¨æ‰€éœ€çš„ç«¯å£ï¼Œè¿™é‡Œå‡è®¾æ˜¯ 8888
            docker run -d \
              --name ${{ env.DOCKER_IMAGE_NAME }} \
              -p 8888:8888 \
              -e ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}" \
              -e ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" \
              -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e OSS_REGION="${{ secrets.OSS_REGION }}" \
              -e OSS_ACCESS_KEY_ID="${{ secrets.OSS_ACCESS_KEY_ID }}" \
              -e OSS_ACCESS_KEY_SECRET="${{ secrets.OSS_ACCESS_KEY_SECRET }}" \
              -e OSS_BUCKET="${{ secrets.OSS_BUCKET }}" \
              ${{ env.DOCKER_IMAGE_NAME }}:amd
              
            # 4. æ¸…ç†æœåŠ¡å™¨ä¸Šçš„ tar æ–‡ä»¶
            echo "æ¸…ç†æœåŠ¡å™¨ä¸Šçš„ tar æ–‡ä»¶"
            rm ${{ env.REMOTE_IMAGE_DIR }}/${{ env.IMAGE_FILE_NAME }}

            # 5. æ¸…ç†æ‚¬ç©ºé•œåƒ
            echo "æ¸…ç†æ‚¬ç©ºé•œåƒ"
            docker image prune -f
